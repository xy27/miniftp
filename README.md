## miniftp 一个简单的ftp服务器

#### 仿照vsftpd实现，可以与windows上的LeapFTP客户端进行通信交互，实现了基本的ftp服务功能

### ftp服务工作原理

    请求响应式通信服务模型。用户使用ftp客户端，操作用户界面完成相应操作，客户端ftp协议解释器解释用户操作，并通过客户端与服务器端之间的控制连接，向服务端发送ftp命令请求，服务端接收并解析命令，然后执行相应的操作，响应客户的请求。整个会话期间，TCP控制连接都存在，传输数据的时候，需要另外建立TCP数据连接，数据传输完毕，断开TCP数据连接
    TCP控制连接: 传输命令及其响应信息；TCP数据连接: 传输实际的文件数据

### 大概设计实现

    仿照vsftpd，服务器并发模型是多进程，一个客户端用户连接上来，fork子进程为其服务，网络I/O模型采用简单的阻塞I/O
    文件传输方式: 只支持二进制传输方式

#### 比较重要的功能(命令)的实现

##### 用户登录验证

##### pasv(被动)  port(主动) 模式的实现

    ftp服务有两种建立数据连接的模式，主动模式，被动模式
    主动模式：客户端创建一个套接字，在一个临时端口上监听，向服务器端发送命令PORT ip，port（即该监听套接字相关的ip,port）， 服务端保存这些信息，在稍后客户端要传输文件时，服务端会创建套接字，并绑定到20端口，主动建立数据连接，客户端accept连接，然后传输数据。
    被动模式：客户端向服务器发送PASV命令，服务端创建一个套接字，在一个临时端口上监听，并向客户端回复该套接字相关的ip，port，客户端接下来要传输文件的话，会主动建立数据连接，服务端accept连接，然后传输数据。
    其中主动模式下，服务器端需要绑定到20端口，普通用户进程没有权限绑定到20端口，一个解决方法是创建一个内部进程，这个进程不与外界进行通信，只是协助ftp服务进程完成ftp数据连接的建立，这个进程称为nobody进程，可以赋予它有限权限，使其能够绑定到20端口。
    因此ftp服务进程与nobody进程之间需要进行通信，而且实际程序中需要在进程间传递文件描述符，因此采用UNIX域协议进行本地进程间通信，具体方式是采用socketpair函数，创建进程间的通信管道，同时需要设计简单的通信协议。

#### 下载 断点续载	上传 断点续传
    下载，上传的时候，使用了简单的记录锁(文件锁)，防止同时写同一个文件，或一个读另一个写同一个文件，但是可以同时读同一个文件。
    断点续载(或续传)，如果客户端中断了当前传输，然后想接着传输，这个时候客户端会发送 REST pos 其中pos指示文件的断点位置，也就是传输了多少字节的数据，服务端可以保存这个信息，用来实现断点续载(续传)

#### 限制文件传输速度  
    睡眠一定时间  由一个简单的数学公式计算睡眠时间

#### abor命令(中断当前传输)实现
    客户端abor功能就是终止当前的数据传输
    如果当前会话正在进行TCP数据连接上的数据传输，此时客户端的abor命令是以紧急模式在TCP控制连接上发送的，此时服务器是无法接收处理abor命令的（进程正在不停地读写数据），要想处理abor命令，服务器端需要开启紧急模式，也就是能够接收处理带外数据。

#### 空闲连接断开
	闹钟定时 

#### 连接数限制
	1.服务器能够服务的最大客户数(最大控制连接数) 2.每个客户端IP地址上能够同时发起的会话请求数

#### 其它
	一些选项（比如传输速率，最大连接数等）可以通过配置文件进行设置